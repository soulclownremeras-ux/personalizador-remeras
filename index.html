<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SoulClown Studio | Diseña tu Estilo</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Permanent+Marker&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #0f0f0f; 
            color: white; 
            overflow: hidden; 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Estilos para Rango (Slider) */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
        }

        .loader { border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000;">
            <div class="loader"></div>
            <p style="margin-top: 20px; font-family: sans-serif; letter-spacing: 2px; font-size: 0.8rem;">CARGANDO STUDIO...</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONOS ---
        const Icons = {
            Shirt: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20.38 3.46L16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"/></svg>,
            Text: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>,
            Image: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Trash: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Rotate: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"/></svg>,
        };

        // --- CONFIGURACIÓN DE PRODUCTOS (CORREGIDO A .PNG) ---
        const PRODUCTS = [
            { 
                id: 'man', 
                name: 'Hombre', 
                image: 'remera-negra.png', // Corregido a .png
                area: { top: '22%', left: '29%', width: '42%', height: '55%' },
                fallbackPath: "M370.5,64.5 c-15.8,18-47.4,17.8-59.6,17.8 c-14.8,0-38.6-2.5-51.4-8.7 C246,67.1,237.4,64.5,221.5,64.5 c-42.6,0-78,1.4-86.8,4.5 c-8.9,3.1-41.6,14-49.8,24.3 c-7.2,9-62.8,77.9-62.8,77.9 s-7.8,11.2,3.1,22 c6.2,6.1,28.8,21.9,28.8,21.9 s9.5,6.1,17.9-3.7 c10.4-12.1,38.2-46.6,38.2-46.6 s4.5-4.5,7.8,1.1 c2.4,4,2.2,217.5,2.2,217.5 s-0.3,37.2,33.5,37.2 c27.1,0,147,0,172.8,0 c33.8,0,32.4-37.2,32.4-37.2 s-0.6-213.5,1.7-217.5 c2.4-4.2,7.8-1.1,7.8-1.1 s27.9,34.5,38.2,46.6 c8.4,9.8,17.9,3.7,17.9,3.7 s22.6-15.8,28.8-21.9 c10.9-10.9,3.1-22,3.1-22 s-55.6-68.9-62.8-77.9 C415.1,81.5,411.5,64.5,370.5,64.5 z"
            },
            { 
                id: 'woman', 
                name: 'Mujer', 
                image: 'remera-mujer.png', // Corregido a .png
                area: { top: '25%', left: '30%', width: '40%', height: '50%' },
                fallbackPath: "M370.5,64.5 c-15.8,18-47.4,17.8-59.6,17.8 c-14.8,0-38.6-2.5-51.4-8.7 C246,67.1,237.4,64.5,221.5,64.5 c-42.6,0-78,1.4-86.8,4.5 c-8.9,3.1-41.6,14-49.8,24.3 c-7.2,9-62.8,77.9-62.8,77.9 s-7.8,11.2,3.1,22 c6.2,6.1,28.8,21.9,28.8,21.9 s9.5,6.1,17.9-3.7 c10.4-12.1,38.2-46.6,38.2-46.6 s4.5-4.5,7.8,1.1 c2.4,4,2.2,217.5,2.2,217.5 s-0.3,37.2,33.5,37.2 c27.1,0,147,0,172.8,0 c33.8,0,32.4-37.2,32.4-37.2 s-0.6-213.5,1.7-217.5 c2.4-4.2,7.8-1.1,7.8-1.1 s27.9,34.5,38.2,46.6 c8.4,9.8,17.9,3.7,17.9,3.7 s22.6-15.8,28.8-21.9 c10.9-10.9,3.1-22,3.1-22 s-55.6-68.9-62.8-77.9 C415.1,81.5,411.5,64.5,370.5,64.5 z"
            },
            { 
                id: 'child', 
                name: 'Niño', 
                image: 'remera-nino.png', // Corregido a .png
                area: { top: '24%', left: '28%', width: '44%', height: '52%' },
                fallbackPath: "M370.5,64.5 c-15.8,18-47.4,17.8-59.6,17.8 c-14.8,0-38.6-2.5-51.4-8.7 C246,67.1,237.4,64.5,221.5,64.5 c-42.6,0-78,1.4-86.8,4.5 c-8.9,3.1-41.6,14-49.8,24.3 c-7.2,9-62.8,77.9-62.8,77.9 s-7.8,11.2,3.1,22 c6.2,6.1,28.8,21.9,28.8,21.9 s9.5,6.1,17.9-3.7 c10.4-12.1,38.2-46.6,38.2-46.6 s4.5-4.5,7.8,1.1 c2.4,4,2.2,217.5,2.2,217.5 s-0.3,37.2,33.5,37.2 c27.1,0,147,0,172.8,0 c33.8,0,32.4-37.2,32.4-37.2 s-0.6-213.5,1.7-217.5 c2.4-4.2,7.8-1.1,7.8-1.1 s27.9,34.5,38.2,46.6 c8.4,9.8,17.9,3.7,17.9,3.7 s22.6-15.8,28.8-21.9 c10.9-10.9,3.1-22,3.1-22 s-55.6-68.9-62.8-77.9 C415.1,81.5,411.5,64.5,370.5,64.5 z"
            },
            { 
                id: 'hoodie', 
                name: 'Buzo', 
                image: 'buzo.png', // Corregido a .png
                area: { top: '28%', left: '32%', width: '36%', height: '40%' },
                fallbackPath: "M100,80 L400,80 L420,150 L460,130 L500,200 L400,250 L400,550 L100,550 L100,250 L0,200 L40,130 L80,150 Z" 
            },
        ];

        function App() {
            // Estados
            const [currentProduct, setCurrentProduct] = useState(PRODUCTS[0]);
            const [elements, setElements] = useState([]); 
            const [selectedId, setSelectedId] = useState(null);
            const [activeTool, setActiveTool] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [imgError, setImgError] = useState({}); // Rastrea qué imágenes fallaron

            const dragItem = useRef(null);
            const dragStartPos = useRef({ x: 0, y: 0 });
            
            // Si cambia el producto, reseteamos el error para intentar cargar la imagen de nuevo
            useEffect(() => {
                // No reseteamos imgError globalmente, solo confiamos en el estado actual
            }, [currentProduct]);

            const addElement = (newEl) => {
                const id = Date.now();
                const el = { ...newEl, id, x: 50, y: 50, rotation: 0, scale: 1 };
                setElements(prev => [...prev, el]);
                setSelectedId(id);
            };

            const updateElement = (id, updates) => {
                setElements(prev => prev.map(el => el.id === id ? { ...el, ...updates } : el));
            };

            const removeElement = (id) => {
                setElements(prev => prev.filter(el => el.id !== id));
                setSelectedId(null);
            };

            const handleStart = (e, id) => {
                e.stopPropagation();
                setSelectedId(id);
                dragItem.current = id;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                dragStartPos.current = { x: clientX, y: clientY };
                setIsDragging(true);
            };

            const handleMove = (e) => {
                if (!isDragging || !dragItem.current) return;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const dx = clientX - dragStartPos.current.x;
                const dy = clientY - dragStartPos.current.y;
                const factor = 0.2; 
                setElements(prev => prev.map(el => {
                    if (el.id === dragItem.current) {
                        return { ...el, x: el.x + dx * factor, y: el.y + dy * factor };
                    }
                    return el;
                }));
                dragStartPos.current = { x: clientX, y: clientY };
            };

            const handleEnd = () => { setIsDragging(false); dragItem.current = null; };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => addElement({ type: 'image', content: ev.target.result, width: 40 });
                    reader.readAsDataURL(file);
                }
            };

            // Manejador de error de imagen
            const handleImgError = (productId) => {
                console.log("Error cargando imagen para:", productId);
                setImgError(prev => ({ ...prev, [productId]: true }));
            };

            // Renderizado Condicional: Imagen Real vs Vector
            const renderProductBase = () => {
                const hasError = imgError[currentProduct.id];

                if (!hasError) {
                    return (
                        <img 
                            src={currentProduct.image} 
                            alt={currentProduct.name} 
                            className="max-h-[85vh] max-w-full object-contain drop-shadow-2xl"
                            onError={() => handleImgError(currentProduct.id)}
                        />
                    );
                } else {
                    // FALLBACK VECTORIAL (SVG) - GRIS PARA QUE SE VEA EN FONDO NEGRO
                    return (
                        <div className="relative w-full h-full flex items-center justify-center">
                            <svg className="w-full h-full max-h-[85vh] drop-shadow-2xl" viewBox="0 0 500 600" xmlns="http://www.w3.org/2000/svg">
                                <g transform="translate(25, 25)">
                                    <path fill="#333333" d={currentProduct.fallbackPath} transform="scale(1.1) translate(-20, 20)" />
                                </g>
                            </svg>
                            <div className="absolute bottom-10 bg-red-900/80 text-white text-[10px] px-2 py-1 rounded">
                                MODO VECTOR (Imagen no encontrada)
                            </div>
                        </div>
                    );
                }
            };

            return (
                <div className="h-screen w-full flex flex-col md:flex-row bg-[#0f0f0f] text-white overflow-hidden"
                    onMouseMove={handleMove} onMouseUp={handleEnd} onTouchMove={handleMove} onTouchEnd={handleEnd}
                >
                    {/* HEADER */}
                    <div className="md:hidden flex justify-between items-center p-4 z-20 bg-[#0f0f0f]/90 backdrop-blur-md sticky top-0 border-b border-white/10">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-black font-black text-xs">SC</div>
                            <span className="font-bold tracking-widest text-sm">SOULCLOWN</span>
                        </div>
                    </div>

                    {/* CANVAS PRINCIPAL */}
                    <div className="flex-1 relative flex items-center justify-center bg-[#1a1a1a] overflow-hidden">
                        <div className="relative w-full max-w-[600px] h-full flex items-center justify-center p-4 animate-pop transition-all duration-500">
                            
                            {/* PRODUCTO BASE (Foto o SVG) */}
                            <div className="relative w-full h-full flex items-center justify-center">
                                {renderProductBase()}

                                {/* AREA DE DISEÑO */}
                                <div className="absolute overflow-hidden" 
                                    style={{ 
                                        top: currentProduct.area.top, left: currentProduct.area.left, 
                                        width: currentProduct.area.width, height: currentProduct.area.height, zIndex: 10
                                    }}>
                                    {elements.map(el => (
                                        <div key={el.id} onMouseDown={(e) => handleStart(e, el.id)} onTouchStart={(e) => handleStart(e, el.id)}
                                            style={{
                                                position: 'absolute', top: `${el.y}%`, left: `${el.x}%`,
                                                transform: `translate(-50%, -50%) rotate(${el.rotation}deg) scale(${el.scale})`,
                                                cursor: 'grab', width: el.type === 'text' ? 'auto' : `${el.width}%`, maxWidth: '100%', touchAction: 'none'
                                            }}
                                            className={`group ${selectedId === el.id ? 'z-50' : 'z-10'}`}
                                        >
                                            {el.type === 'text' ? (
                                                <div className="whitespace-nowrap font-bold text-2xl font-sans px-2 py-1"
                                                    style={{ color: el.color, textShadow: '0 2px 4px rgba(0,0,0,0.5)' }}>
                                                    {el.content}
                                                </div>
                                            ) : (
                                                <img src={el.content} className="w-full h-full object-contain pointer-events-none drop-shadow-md" />
                                            )}
                                            {selectedId === el.id && (
                                                <div className="absolute -inset-4 border-2 border-white/50 rounded-lg pointer-events-none">
                                                    <div className="absolute -top-3 -right-3 bg-red-600 text-white p-1.5 rounded-full shadow-lg cursor-pointer pointer-events-auto hover:scale-110 transition"
                                                        onTouchStart={(e) => { e.stopPropagation(); removeElement(el.id); }}
                                                        onMouseDown={(e) => { e.stopPropagation(); removeElement(el.id); }}>
                                                        <Icons.Trash />
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* PANEL DE HERRAMIENTAS */}
                    <div className="bg-[#111] border-t border-white/10 z-20 flex flex-col pb-safe w-full md:w-auto">
                        {/* Sub-Menú */}
                        {activeTool && (
                            <div className="bg-[#1a1a1a] p-4 animate-pop border-b border-white/5 absolute bottom-full w-full left-0 md:static md:w-80">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-widest">
                                        {activeTool === 'product' && 'SELECCIONA PRENDA'}
                                        {activeTool === 'text' && 'AGREGAR TEXTO'}
                                        {activeTool === 'edit' && 'AJUSTES'}
                                    </h3>
                                    <button onClick={() => setActiveTool(null)} className="text-gray-500 hover:text-white"><Icons.Check/></button>
                                </div>
                                <div className="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                                    {activeTool === 'product' && PRODUCTS.map(p => (
                                        <button key={p.id} onClick={() => setCurrentProduct(p)} 
                                            className={`flex flex-col items-center gap-2 min-w-[80px] p-2 rounded-lg transition ${currentProduct.id === p.id ? 'bg-white/10 ring-1 ring-white' : 'hover:bg-white/5'}`}>
                                            <div className="w-12 h-12 rounded-full overflow-hidden bg-gray-800 border border-white/10 flex items-center justify-center">
                                                {/* Miniatura con fallback */}
                                                {!imgError[p.id] ? 
                                                    <img src={p.image} className="w-full h-full object-cover" onError={() => handleImgError(p.id)} /> :
                                                    <Icons.Shirt className="text-white/50" />
                                                }
                                            </div>
                                            <span className="text-[10px] font-bold uppercase">{p.name}</span>
                                        </button>
                                    ))}
                                    {activeTool === 'text' && (
                                        <div className="flex gap-2 w-full">
                                            <input type="text" placeholder="TU FRASE..." className="flex-1 bg-transparent border-b border-white text-white p-2 outline-none font-bold text-lg uppercase" 
                                                onKeyDown={(e) => { if(e.key === 'Enter' && e.target.value) { addElement({ type: 'text', content: e.target.value, color: '#ffffff' }); e.target.value = ''; } }} />
                                            <button className="bg-white text-black px-4 font-bold rounded hover:bg-gray-200" onClick={(e) => { const input = e.target.previousSibling; if(input.value) { addElement({ type: 'text', content: input.value, color: '#ffffff' }); input.value = ''; } }}>OK</button>
                                        </div>
                                    )}
                                    {activeTool === 'edit' && selectedId && (
                                        <div className="flex flex-col w-full gap-4">
                                            <div className="flex items-center gap-4"><span className="text-xs w-12 text-gray-400 font-mono">ROTAR</span><input type="range" min="0" max="360" className="flex-1 accent-white" onChange={(e) => updateElement(selectedId, { rotation: parseInt(e.target.value) })} /></div>
                                            <div className="flex items-center gap-4"><span className="text-xs w-12 text-gray-400 font-mono">TAMAÑO</span><input type="range" min="0.5" max="3" step="0.1" className="flex-1 accent-white" onChange={(e) => updateElement(selectedId, { scale: parseFloat(e.target.value) })} /></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {/* Barra Principal */}
                        <div className="flex justify-around items-center p-2 md:p-6 w-full max-w-4xl mx-auto bg-[#111]">
                            <button onClick={() => setActiveTool(activeTool === 'product' ? null : 'product')} className={`flex flex-col items-center justify-center p-3 rounded-xl transition-all duration-300 ${activeTool === 'product' ? 'bg-white text-black scale-105' : 'text-gray-400 hover:text-white'}`}>
                                <Icons.Shirt /><span className="text-[10px] mt-1 font-black uppercase tracking-widest">PRENDA</span>
                            </button>
                            <button onClick={() => setActiveTool(activeTool === 'text' ? null : 'text')} className={`flex flex-col items-center justify-center p-3 rounded-xl transition-all duration-300 ${activeTool === 'text' ? 'bg-white text-black scale-105' : 'text-gray-400 hover:text-white'}`}>
                                <Icons.Text /><span className="text-[10px] mt-1 font-black uppercase tracking-widest">TEXTO</span>
                            </button>
                            <label className="flex flex-col items-center justify-center p-3 text-gray-400 hover:text-white cursor-pointer transition-all hover:scale-105">
                                <Icons.Image /><span className="text-[10px] mt-1 font-black uppercase tracking-widest">SUBIR</span>
                                <input type="file" accept="image/*" className="hidden" onChange={handleImageUpload} />
                            </label>
                            {selectedId && (
                                <button onClick={() => setActiveTool(activeTool === 'edit' ? null : 'edit')} className={`flex flex-col items-center justify-center p-3 rounded-xl transition-all duration-300 ${activeTool === 'edit' ? 'bg-white text-black scale-105' : 'text-gray-400 hover:text-white'}`}>
                                    <Icons.Rotate /><span className="text-[10px] mt-1 font-black uppercase tracking-widest">AJUSTES</span>
                                </button>
                            )}
                            <button onClick={() => alert('Diseño listo para enviar a SoulClown.')} className="ml-4 bg-white text-black px-6 py-2 rounded-full font-black tracking-widest hover:scale-105 transition shadow-lg hidden md:block">FINALIZAR</button>
                        </div>
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
